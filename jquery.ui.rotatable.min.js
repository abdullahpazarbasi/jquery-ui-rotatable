/**
 * jQuery UI Rotatable Widget
 *
 * @author Abdullah Pazarbasi (https://github.com/abdullahpazarbasi/jquery-ui-rotatable)
 * @license MIT
 *
 * Features:
 * Supports CSS 2D transform (only 2D)
 * Rotation by mouse wheel
 * Rotation with/without handle
 * Compatible with other jQuery UI widgets included Draggable and Resizable
 * Compatible with Dave Furfero's jQuery UI Touch Punch
 * All angles in degrees
 * AlsoRotate extension
 *
 * Usages:
 * $('#foo .bar').rotatable();
 * $('#foo .bar').resizable().rotatable().draggable();
 * $('#foo .bar').rotatable({ angle: 30 });
 *
 * Inspired by jQuery UI Resizable Widget and Aidan Rogers's (godswearhats) jquery-ui-rotatable Widget
 * Thanks to jQuery UI Development Team (https://jqueryui.com/about/)
 * Thanks to Aidan Rogers (https://github.com/godswearhats/jquery-ui-rotatable)
 */
!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t(jQuery)}(function(t){t.widget("ui.rotatable",t.ui.mouse,{widgetEventPrefix:"rotate",options:{classes:{},create:null,distance:1,delay:0,disabled:!1,alsoRotate:!1,angle:void 0,handle:!0,handleElementSelector:"<div></div>",rotationOriginPosition:{top:null,left:null},snap:!1,snapStep:22.5,start:function(t,e){return!0},rotate:function(t,e){return!0},stop:function(t,e){return!0},wheel:!0,wheelingVerticalStep:null,wheelingHorizontalStep:null},plugins:{},handlers:{},elementStartAngle:0,elementCurrentAngle:0,elementStopAngle:0,mouseStartAngle:null,_num:function(t){return parseFloat(t)||0},_isNumber:function(t){return!isNaN(parseFloat(t))},_round:function(t,e){var n=this._num(t),i=Math.pow(10,e),s=n*i;return Math.round(s)/i},_canBeParent:function(){return!this.element[0].nodeName.match(/^(canvas|textarea|input|select|button|img)$/i)},_enableSelection:function(t){return t.attr("unselectable","off"),t.css("user-select","auto"),t.off(".ui-disableSelection")},_disableSelection:function(t){t.attr("unselectable","on"),t.css("user-select","none");var e="onselectstart"in document.createElement("div")?"selectstart":"mousedown";return t.on(e+".ui-disableSelection",function(t){t.preventDefault()})},_angleInDegrees:function(t){return 180*t/Math.PI},_calculateAbsoluteAngle:function(t){return t>360?t-360:t<0?t+360:t},_calculateSnap:function(t){return Math.round(t/this.options.snapStep)*this.options.snapStep},_getElementOffset:function(){var t=this.element;this.perform(t,0);var e=t.offset();return this.perform(t,this.elementCurrentAngle),e},_isRotationOriginPositionGiven:function(){return"number"==typeof this.options.rotationOriginPosition.top||"number"==typeof this.options.rotationOriginPosition.left},getRotationOriginPositionTop:function(t){return"number"==typeof this.options.rotationOriginPosition.top?this.options.rotationOriginPosition.top:Math.round(t.height()/2)},getRotationOriginPositionLeft:function(t){return"number"==typeof this.options.rotationOriginPosition.left?this.options.rotationOriginPosition.left:Math.round(t.width()/2)},_calculateOrigin:function(){var t=this.element,e=this._getElementOffset();if(this._isRotationOriginPositionGiven())return{x:e.left+this.getRotationOriginPositionLeft(t),y:e.top+this.getRotationOriginPositionTop(t)};var n=t.css("transform-origin");if("string"==typeof n){var i=n.match(/([\d.]+)px +([\d.]+)px/);if(null!==i)return{x:e.left+this._num(i[1]),y:e.top+this._num(i[2])}}return{x:e.left+Math.round(t.width()/2),y:e.top+Math.round(t.height()/2)}},_calculateRotationAngleViaMousePosition:function(t){var e=this._calculateOrigin(),n=this._calculateMouseAngle(t,e)-this._num(this.mouseStartAngle)+this.elementStartAngle;return this.options.snap&&(n=this._calculateSnap(n)),this._calculateAbsoluteAngle(n)},_calculateMouseAngle:function(t,e){var n=t.pageX-e.x,i=t.pageY-e.y;return this._angleInDegrees(Math.atan2(i,n))},perform:function(t,e){var n=null,i=t.css("transform");if(void 0===i)return 0;this._isRotationOriginPositionGiven()&&t.css("transform-origin",this.getRotationOriginPositionLeft(t)+"px "+this.getRotationOriginPositionTop(t)+"px");var s="";if("none"!==i){var o=/matrix\((.*),(.*),(.*),(.*),(.*),(.*)\)/.exec(i);if(null!==o){var a=this._num(o[1]),r=this._num(o[2]),l=this._num(o[3]),u=this._num(o[4]),h=this._num(o[5]),c=this._num(o[6]);0!==h&&(s+=0===c?"translate("+h+"px) ":"translate("+h+"px, "+c+"px) ");var g=a*u-r*l,d=null,f=null;if(0!==a||0!==r){var p=this._round(Math.sqrt(a*a+r*r),5);n=this._angleInDegrees(r>0?Math.acos(a/p):-Math.acos(a/p)),void 0===e&&(e=n),d=p,f=this._round(g/p,5),1===d&&1===f||(s+="scale("+d+(d===f?"":", "+f)+") "),0!==(d=Math.atan((a*l+r*u)/(p*p)))&&(s+="skewX("+this._angleInDegrees(d)+"deg) ")}else if(0!==l||0!==u){var m=Math.sqrt(l*l+u*u);n=this._angleInDegrees(Math.PI/2-(u>0?Math.acos(-l/m):-Math.acos(l/m))),void 0===e&&(e=n),f=m,1===(d=g/m)&&1===f||(s+="scale("+d+(d===f?"":", "+f)+") "),0!==(d=Math.atan((a*l+r*u)/(m*m)))&&(s+="skewY("+this._angleInDegrees(d)+"deg) ")}else s+="scale(0) "}}return s+="rotate("+(e=this._calculateAbsoluteAngle(this._num(e)))+"deg) ",t.css("transform",s),e},_angle:function(t){return this.elementCurrentAngle=this.perform(this.element,t),this.elementCurrentAngle},_create:function(){var e=this.options;this.handlers={_mouseWheel:t.proxy(this._mouseWheel,this)},this.element.addClass("ui-rotatable"),e.handle&&this._placeHandle(),e.wheel&&this.element.bind("wheel",this.handlers._mouseWheel),this.rotationOriginPosition(e.rotationOriginPosition),this._angle(e.angle),this._mouseInit()},_destroy:function(){this._mouseDestroy(),this.element.removeClass("ui-rotatable ui-rotatable-rotating ui-rotatable-rotated"),this.element.off("rotatable"),this.element.find(".ui-rotatable-handle").remove(),this.options.wheel&&this.element.unbind("wheel",this.handlers._mouseWheel)},_placeHandle:function(){var e=this.options;if(this.element&&!this.element.disabled&&!e.disabled&&this._canBeParent()){var n=this.element.find(".ui-rotatable-handle:first");n.length<1&&((n=t(e.handleElementSelector)).addClass("ui-rotatable-handle"),n.appendTo(this.element),this._disableSelection(n));var i=n.css("top"),s=n.css("right"),o=n.css("bottom"),a=n.css("left");"absolute"!==n.css("position")&&n.css("position","absolute"),n.width()<1&&n.width(9),n.height()<1&&n.height(9),"auto"===i&&"auto"===o&&n.css("top","0px"),"auto"===a&&"auto"===s&&n.css("left","0px"),"auto"===n.css("cursor")&&n.css("cursor","grab")}},_displaceHandle:function(){},_getJqHandle:function(){return this.options.handle?this.element.find(".ui-rotatable-handle:first"):this.element},_setOption:function(t,e){this._super(t,e)},_mouseCapture:function(t){var e=this.element,n=this.options;if(!e||e.disabled||n.disabled)return!1;if(n.handle){var i=this._getJqHandle();if(t.target!==i[0])return!1}else if(t.target!==e[0])return!1;return!0},_mouseStart:function(e){var n=this.element;if(!n||n.disabled||this.options.disabled)return!1;var i=this._getJqHandle(),s=this._calculateOrigin();this.mouseStartAngle=this._calculateMouseAngle(e,s),this.elementStartAngle=this.elementCurrentAngle,n.removeClass("ui-rotatable-rotated"),n.addClass("ui-rotatable-rotating"),i.length>0&&"grab"===i.css("cursor")&&i.css("cursor","grabbing");var o=this.ui();return t.ui.plugin.call(this,"start",[e,o]),this._trigger("start",e,o)},_mouseDrag:function(e,n){var i=this.element;if(!i||i.disabled||this.options.disabled)return!1;var s=this._calculateRotationAngleViaMousePosition(e),o=this.elementCurrentAngle;this.elementCurrentAngle=s;var a=this.ui();return t.ui.plugin.call(this,"rotate",[e,a]),!1===this._trigger("rotate",e,a)?(this.elementCurrentAngle=o,!1):(o!==this._angle(s)&&i.addClass("ui-rotatable-rotated"),!1)},_mouseStop:function(e){var n=this.element;if(!n||n.disabled||this.options.disabled)return!1;this.elementStopAngle=this.elementCurrentAngle,n.removeClass("ui-rotatable-rotating");var i=this._getJqHandle();i.length>0&&"grabbing"===i.css("cursor")&&i.css("cursor","grab");var s=this.ui();return t.ui.plugin.call(this,"stop",[e,s]),this._trigger("stop",e,s),this.mouseStartAngle=null,!1},_mouseWheel:function(e){var n=this.options;if(!this.element||this.element.disabled||n.disabled)return!0;var i=1,s=1,o=this._num(n.snapStep);0!==o&&(i=o,s=o),"number"==typeof n.wheelingVerticalStep&&(s=i=n.wheelingVerticalStep),"number"==typeof n.wheelingHorizontalStep&&(s=n.wheelingHorizontalStep);var a=0;if(this._num(e.originalEvent.deltaY)>0?a=i:this._num(e.originalEvent.deltaY)<0?a=-1*i:this._num(e.originalEvent.deltaX)>0?a=s:this._num(e.originalEvent.deltaX)<0&&(a=-1*s),n.snap&&(a=this._calculateSnap(a)),0===a)return!0;a=this.elementCurrentAngle+a,this._angle(a);var r=this.ui();return t.ui.plugin.call(this,"rotate",[e,r]),this._trigger("rotate",e,r),!1},angle:function(t){var e=this.options;if(void 0===t)return e.angle;e.angle=this._angle(t)},handle:function(t){var e=this.options;if(void 0===t)return e.handle;t?e.handle||this._placeHandle():e.handle&&this._displaceHandle(),e.handle=t},wheel:function(t){var e=this.element,n=this.options;if(void 0===t)return n.wheel;t?n.wheel||e.bind("wheel",this.handlers._mouseWheel):n.wheel&&e.unbind("wheel",this.handlers._mouseWheel),n.wheel=t},handleElementSelector:function(t){var e=this.options;if(void 0===t)return e.handleElementSelector;e.handleElementSelector!==t&&(this._displaceHandle(),e.handleElementSelector=t,e.handle&&this._placeHandle())},rotationOriginPosition:function(t){var e=this.options;if(void 0===t)return e.rotationOriginPosition;"number"==typeof t.top&&(e.rotationOriginPosition.top=t.top),"number"==typeof t.left&&(e.rotationOriginPosition.left=t.left)},currentAngle:function(){return this.elementCurrentAngle},ui:function(){return{element:this.element,angle:{mouseStart:this.mouseStartAngle,start:this.elementStartAngle,current:this.elementCurrentAngle,stop:this.elementStopAngle}}}}),t.ui.plugin.add("rotatable","animate",{stop:function(t,e){}}),t.ui.plugin.add("rotatable","alsoRotate",{start:function(e,n){var i=t(this).rotatable("instance").options;t(i.alsoRotate).each(function(){t(this)})},rotate:function(e,n){var i=t(this).rotatable("instance"),s=i.options;t(s.alsoRotate).each(function(){var e=t(this);i.perform(e,i.elementCurrentAngle)})},stop:function(t,e){}});t.ui.rotatable;return t.ui.rotatable});
